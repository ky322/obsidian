### ACID
- Atomicity: No Partial execution
- Consistency: Data remains consistent
- Isolation: Simulate serial execution
- Durability: No lost data
### Durability Challenges
- Guarantee: Effects of committed transactions persist
	- Must still hold in case of sudden power failure
- Changes to data are initially written to buffer pool
- Buffer pool in main memory therefore volatile
### Atomicity Challenges
- Guarantees no transaction is partially executed
- Can leave changes in main memory until commit
	- Each transaction holds many buffer slots
	- Bad throughput: Few transactions execute concurrently
- Alternative: Write changes to disk to free up memory
	- We have partial results persistent on hard disk
	- May need to undo changes to achieve atomicity
$\begin{array}{|c|c|c|} \hline & \textbf{No Steal (Buffer Pages from Ongoing Transactions)} & \textbf{Allow Steal} \\ \hline{\textbf{Force (Every Change to Disk)}} & \text{Poor response time,} & \text{Poor response time} \\ & \text{poor throughput} & \\ \hline {\textbf{No Force}} & \text{Poor throughput} & \text{Good time \& throughput} \\ & & \\ \hline \end{array}$
### Logging For Durability
- Need to persist changes before commit for durability
- Updating actual data before commit is inefficient
	- Need to write lots of pages with small changes
- Idea: Only store deltas in compact representation
	- Write one page with deltas instead of many data pages
	- Write deltas before commit for recovery after restart
	- Those deltas form part of the log
### Logging for Atomicity
- Want to swap buffer pages between ongoing transactions
- Need to persist changes on swapped buffer pages
	- Changes are lost otherwise, losing durability
- May have uncommitted changes persistent on disk
- Must be able to undo changes to guarantee atomicity
- Write log entries to enable undoing updates
### Write Ahead Logging
1. Write all log entries of a transaction before commit
	- Guarantees durability 
	- Use log entries for redo in case of a crash
2. Write all log entries of a buffer page before persisting
	- Guarantees atomicity
	- Use log entries for undo in case of a crash
### ARIES Algorithm
- Recovery algorithm
- Uses write-ahead logging at run time
- Executes multiple phases after a crash
	- Analysis: Determines transactions to undo or redo via log
	- Redo: Get back to state directly before crash
	- Undo: Undo effects of aborted transactions
### Log Trail
#### Type of Log Entries
- Update: States new and prior value after data update
	- New value for redo and old value for undo
- Commit: Indicates that a transaction committed
- Abort: Indicates that a transaction aborted
- End: Indicates cleanup for transaction finished
#### Log Entry Fields
- Each log entry has an ID, the log sequence number LSN
- `TransID`: Transaction generated by the log entry
- `PrevLSN`: LSN of previous entry for same transaction
- Type: Type of log entry
#### Added Fields for Updates
- `PageID`: Logging update that refers to this page
- Length: So many bytes were changed by update
- Offset: First byte on page affected by update
- Before-Image: Original value before update
- After-Image: New value after update
### Flushed LSN
- `FlushedLSN`: Log entries persistent up to this entry
- Can exploit to verify rules of write-ahead logging
- Must persist transaction log entries before commit
	- `FlushedLSN >= Transaction LastLSN`
- Must persist log entries about page before disk write
	- `FlushedLSN >= PageLSN of Page`
### Transaction Table
- Contains one entry for each active transaction
- Stores for each transaction three fields:
	- `TransID`: Transaction ID
	- Status: Running, committed, aborted
	- `LastLSN`: ID of last log entry by that transaction
### Dirty Page Table
- Dirty Page: In-Memory version differs from disk version
	- Changes would be lost by crash
- Dirty page table stores one entry per dirty page storing
	- `PageID`: ID of dirty page
	- `RecLSN`: LSN of first log entry making page dirty 
### Page `LastLSN`
- LSN of the last operation changing that page
- Stored for each page in memory and each page on disk
- `LastLSN` of disk and memory version of page may differ 
